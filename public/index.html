<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>China Auto Dashboard</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; margin:0; background:#f8f9fb; color:#222; }
    header { background:#004aad; color:#fff; padding:.8em 1.2em; text-align:center; font-size:1.2em; font-weight:600; }
    #tabs { display:flex; flex-wrap:wrap; justify-content:center; gap:6px; padding:.6em; background:#fff; border-bottom:1px solid #ddd; }
    .tab-btn { padding:6px 10px; background:#e8eefc; color:#004aad; border-radius:4px; border:1px solid #c2d3f0; cursor:pointer; font-size:.9em; }
    .tab-btn.active { background:#004aad; color:#fff; font-weight:700; }
    main { padding:1em; overflow-x:auto; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:6px; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,.08); }
    th,td { padding:8px 10px; border-bottom:1px solid #eee; text-align:left; white-space:nowrap; }
    th { background:#f0f2f5; font-weight:600; }
    tr:hover { background:#fafafa; }
    a.model-link { color:#004aad; text-decoration:none; font-weight:500; }
    a.model-link:hover { text-decoration:underline; }
    .change-up { color:#00a000; font-weight:700; }
    .change-down { color:#d00000; font-weight:700; }
    .change-same { color:#888; }
    .toast { margin:1em; padding:.6em 1em; border-radius:5px; display:inline-block; font-size:.9em; }
    .good { background:#e6f4ea; color:#1e6823; border:1px solid #b8dfb9; }
    .err { background:#fde4e4; color:#a22; border:1px solid #f3b8b8; }
    @media (max-width:768px){ table{font-size:14px} th,td{padding:6px 8px} .tab-btn{font-size:.8em;padding:5px 8px}}
  </style>
  <!-- PapaParseï¼ˆæ­£ã—ã„CSVãƒ‘ãƒ¼ã‚¹ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
</head>
<body>
  <header>ğŸš— China Auto Dashboard</header>
  <div id="ah-status" class="toast">Autohome ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</div>
  <div id="tabs"></div>

  <main>
    <table id="ah-table">
      <thead>
        <tr>
          <th>é †ä½</th>
          <th>å¤‰å‹•</th>
          <th>è»Šå</th>
          <th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th>
          <th>å°æ•°</th>
          <th>ä¾¡æ ¼</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="6">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
      </tbody>
    </table>
  </main>

  <script>
  // å…¬é–‹ã•ã‚ŒãŸCSVã¸ã®ç›¸å¯¾ãƒ‘ã‚¹ï¼ˆæ§‹é€ ã¯ç¶­æŒï¼‰
  const CSV_PATH = "output/pipeline/autohome-ranking-csvs/autohome_ranking_with_image_urls_with_maker_with_maker_ja.csv";
  let ALL = [];

  // åˆ—åã‚†ã‚‰ãå¸åï¼ˆBOMã‚„è¡¨è¨˜é•ã„ã‚’å¸åï¼‰
  function normKey(k){ return (k||"").replace(/^\uFEFF/,"").trim().toLowerCase(); }
  function pick(row, keys){
    for(const k of keys){
      const v = row[k] ?? row[normKey(k)];
      if (v !== undefined && v !== null && String(v).trim() !== "") return String(v).trim();
    }
    return "";
  }

  function rankDiff(now, last){
    const rn = parseInt(now||"0",10), rl = parseInt(last||"0",10);
    if(!rl) return {txt:"", cls:"change-same"};
    const d = rl - rn;
    if (d > 0) return {txt:"â–²"+d, cls:"change-up"};
    if (d < 0) return {txt:"â–¼"+(-d), cls:"change-down"};
    return {txt:"â€“", cls:"change-same"};
  }

  function renderTabs(makers){
    const tabs = document.getElementById("tabs");
    tabs.innerHTML = "";
    const mkBtn = (label, onClick, active=false)=>{
      const b = document.createElement("button");
      b.className = "tab-btn" + (active ? " active" : "");
      b.textContent = label;
      b.onclick = ()=>{ document.querySelectorAll(".tab-btn").forEach(x=>x.classList.remove("active")); b.classList.add("active"); onClick();};
      tabs.appendChild(b);
    };
    mkBtn("å…¨ãƒ¡ãƒ¼ã‚«ãƒ¼", ()=>renderTable(ALL), true);
    makers.forEach(m => mkBtn(m, ()=>renderTable(ALL.filter(r => (pick(r,["manufacturer_ja","manufacturer"])===m)))));
  }

  function renderTable(data){
    const tbody = document.querySelector("#ah-table tbody");
    tbody.innerHTML = "";
    data.forEach(row=>{
      const rank = pick(row, ["rank"]);
      const last = pick(row, ["rank_last","last_rank","rank_prev"]);
      const diff = rankDiff(rank, last);

      const model = pick(row, ["model","series","è»Šå"]);
      const mfr   = pick(row, ["manufacturer_ja","manufacturer","brand","ãƒ–ãƒ©ãƒ³ãƒ‰"]);
      const sales = pick(row, ["sales","å°æ•°","sales_cnt"]);
      const price = pick(row, ["price","ä¾¡æ ¼"]);
      const link  = pick(row, ["series_url","url","link"]);

      const modelHtml = link ? `<a href="${link}" class="model-link" target="_blank" rel="noopener">${model}</a>` : model;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${rank}</td>
        <td class="${diff.cls}">${diff.txt}</td>
        <td>${modelHtml}</td>
        <td>${mfr}</td>
        <td>${sales}</td>
        <td>${price}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function main(){
    const status = document.getElementById("ah-status");
    try{
      const res = await fetch(CSV_PATH, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP "+res.status);
      const text = await res.text();

      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      // ã‚­ãƒ¼ã‚’æ­£è¦åŒ–ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ï¼ˆBOM/å¤§æ–‡å­—å°æ–‡å­—å·®ç•°ã‚’å¸åï¼‰
      ALL = parsed.data.map(row=>{
        const o={};
        Object.keys(row).forEach(k=>{ o[normKey(k)] = row[k]; });
        return o;
      });

      // ãƒ¡ãƒ¼ã‚«ãƒ¼ä¸€è¦§ã‚’ä½œæˆ
      const makers = [...new Set(ALL.map(r => pick(r,["manufacturer_ja","manufacturer"]))).values()]
        .filter(Boolean).sort((a,b)=>a.localeCompare(b,'ja'));
      renderTabs(makers);
      renderTable(ALL);

      status.className = "toast good";
      status.textContent = "Autohome CSV èª­ã¿è¾¼ã¿æˆåŠŸ âœ”";
    }catch(e){
      console.error(e);
      status.className = "toast err";
      status.textContent = "Autohome CSV èª­ã¿è¾¼ã¿å¤±æ•— ("+e.message+")";
      document.querySelector("#ah-table tbody").innerHTML = `<tr><td colspan="6">ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼</td></tr>`;
    }
  }

  // PapaParseãƒ­ãƒ¼ãƒ‰å¾Œã«å®Ÿè¡Œ
  if (window.Papa) main(); else window.addEventListener("load", main);
  </script>
</body>
</html>
