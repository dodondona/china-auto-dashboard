<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>China Auto Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background: #f5f6fa; font-family: "Noto Sans JP", sans-serif; }
    header { background: #0052cc; color: white; padding: 10px 16px; font-size: 1.3rem; font-weight: bold; }
    table { background: white; }
    th { background: #f0f3f7; white-space: nowrap; }
    .rank-up { color: red; font-weight: bold; }
    .rank-down { color: blue; font-weight: bold; }
    .maker-tab { margin: 4px; }
    img.thumb { height: 40px; border-radius: 4px; }
  </style>
</head>
<body>
  <header>ğŸš— China Auto Dashboard</header>

  <div class="container mt-3">
    <div id="status" class="alert alert-info small">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="makerTabs" class="mb-3 text-center"></div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle" id="carTable">
        <thead>
          <tr>
            <th>é †ä½</th><th>å¤‰å‹•</th><th>è»Šå</th><th>ãƒ¡ãƒ¼ã‚«ãƒ¼</th><th>å°æ•°</th><th>ä¾¡æ ¼</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const CSV_PATH = "output/pipeline/autohome-ranking-csvs/autohome_ranking_with_image_urls_with_maker_with_maker_ja.csv";

    async function main() {
      try {
        const response = await fetch(CSV_PATH);
        if (!response.ok) throw new Error("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
        const csvText = await response.text();

        const data = Papa.parse(csvText, { header: true }).data;
        if (!data.length) throw new Error("CSVãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™");

        document.getElementById("status").className = "alert alert-success";
        document.getElementById("status").textContent = "Autohome CSV èª­ã¿è¾¼ã¿æˆåŠŸ âœ”";

        renderTable(data);
        renderMakerTabs(data);
      } catch (err) {
        document.getElementById("status").className = "alert alert-danger";
        document.getElementById("status").textContent = "Autohome CSV èª­ã¿è¾¼ã¿å¤±æ•— âŒ (" + err.message + ")";
      }
    }

    function renderTable(data, maker = null) {
      const tbody = document.querySelector("#carTable tbody");
      tbody.innerHTML = "";

      data
        .filter(row => !maker || row.manufacturer_ja === maker)
        .forEach(row => {
          const diff = parseInt(row.rank_diff || "0");
          const diffText = diff > 0 ? `<span class='rank-up'>â†‘${diff}</span>` :
                           diff < 0 ? `<span class='rank-down'>â†“${Math.abs(diff)}</span>` : "â€“";
          const html = `
            <tr>
              <td>${row.rank}</td>
              <td>${diffText}</td>
              <td><a href="${row.series_url}" target="_blank">${row.model_name}</a></td>
              <td>${row.manufacturer_ja}</td>
              <td>${row.sales}</td>
              <td>${row.price}</td>
            </tr>`;
          tbody.insertAdjacentHTML("beforeend", html);
        });
    }

    function renderMakerTabs(data) {
      const makers = [...new Set(data.map(d => d.manufacturer_ja).filter(Boolean))];
      const container = document.getElementById("makerTabs");
      container.innerHTML = `<button class='btn btn-primary maker-tab' onclick='renderTable(window._data)'>å…¨ãƒ¡ãƒ¼ã‚«ãƒ¼</button>`;
      makers.forEach(m => {
        const btn = document.createElement("button");
        btn.textContent = m;
        btn.className = "btn btn-outline-primary maker-tab";
        btn.onclick = () => renderTable(window._data, m);
        container.appendChild(btn);
      });
      window._data = data;
    }

    main();
  </script>
</body>
</html>
