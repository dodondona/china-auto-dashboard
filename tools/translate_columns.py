from __future__ import annotations
import os, json, time, re
from pathlib import Path
import pandas as pd
from openai import OpenAI

# ====== å…¥å‡ºåŠ› ======
SERIES_ID = os.environ.get("SERIES_ID", "").strip()

def resolve_src_dst():
    csv_in  = os.environ.get("CSV_IN", "").strip()
    csv_out = os.environ.get("CSV_OUT", "").strip()

    def guess_paths_from_series(sid: str):
        if not sid:
            return None, None
        base = f"output/autohome/{sid}/config_{sid}"
        return Path(f"{base}.csv"), Path(f"{base}.ja.csv")

    default_in  = Path("output/autohome/7578/config_7578.csv")
    default_out = Path("output/autohome/7578/config_7578.ja.csv")

    src = Path(csv_in)  if csv_in  else None
    dst = Path(csv_out) if csv_out else None

    if src is None or dst is None:
        s2, d2 = guess_paths_from_series(SERIES_ID)
        src = src or s2
        dst = dst or d2

    src = src or default_in
    dst = dst or default_out
    return src, dst

SRC, DST_PRIMARY = resolve_src_dst()

def make_secondary(dst: Path) -> Path:
    s = dst.name
    if s.endswith(".ja.csv"):
        s2 = s.replace(".ja.csv", "_ja.csv")
    elif s.endswith("_ja.csv"):
        s2 = s.replace("_ja.csv", ".ja.csv")
    else:
        s2 = dst.stem + ".ja.csv"
    return dst.parent / s2

DST_SECONDARY = make_secondary(DST_PRIMARY)

# ====== è¨­å®š ======
MODEL   = os.environ.get("OPENAI_MODEL", "gpt-4.1-mini")
API_KEY = os.environ.get("OPENAI_API_KEY")

TRANSLATE_VALUES   = os.environ.get("TRANSLATE_VALUES", "true").lower() == "true"
TRANSLATE_COLNAMES = os.environ.get("TRANSLATE_COLNAMES", "true").lower() == "true"
STRIP_GRADE_PREFIX = os.environ.get("STRIP_GRADE_PREFIX", "true").lower() == "true"
SERIES_PREFIX_RE   = os.environ.get("SERIES_PREFIX", "").strip()
EXRATE_CNY_TO_JPY  = float(os.environ.get("EXRATE_CNY_TO_JPY", "21.0"))

# ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜ã™ã‚‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆç·¨é›†å¯ï¼‰
CACHE_REPO_DIR     = os.environ.get("CACHE_REPO_DIR", "cache").strip()

BATCH_SIZE, RETRIES, SLEEP_BASE = 60, 3, 1.2

# ====== ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚° ======
NOISE_ANY = ["å¯¹æ¯”","å‚æ•°","å›¾ç‰‡","é…ç½®","è¯¦æƒ…"]
NOISE_PRICE_TAIL = ["è¯¢ä»·","è®¡ç®—å™¨","è¯¢åº•ä»·","æŠ¥ä»·","ä»·æ ¼è¯¢é—®","èµ·","èµ·å”®","åˆ°åº—","ç»é”€å•†"]

def clean_any_noise(s:str)->str:
    s=str(s) if s is not None else ""
    for w in NOISE_ANY+NOISE_PRICE_TAIL:
        s=s.replace(w,"")
    return re.sub(r"\s+"," ",s).strip(" ã€€-â€”â€“")

def clean_price_cell(s:str)->str:
    t=clean_any_noise(s)
    for w in NOISE_PRICE_TAIL:
        t=re.sub(rf"(?:\s*{re.escape(w)}\s*)+$","",t)
    return t.strip()

# ====== ä¾¡æ ¼æ•´å½¢ ======
RE_WAN=re.compile(r"(?P<num>\d+(?:\.\d+)?)\s*ä¸‡")
RE_YUAN=re.compile(r"(?P<num>[\d,]+)\s*å…ƒ")
RE_PAREN_ANY_YEN=re.compile(r"ï¼ˆ[^ï¼‰]*(?:æ—¥æœ¬å††|JPY|[Â¥ï¿¥]|å††)[^ï¼‰]*ï¼‰")
RE_ANY_YEN_TOKEN=re.compile(r"(æ—¥æœ¬å††|JPY|[Â¥ï¿¥]|å††)")

def strip_any_yen_tokens(s:str)->str:
    t=str(s)
    t=RE_PAREN_ANY_YEN.sub("",t)
    t=RE_ANY_YEN_TOKEN.sub("",t)
    return re.sub(r"\s+"," ",t).strip()

def parse_cny(text:str):
    t=str(text)
    m1=RE_WAN.search(t)
    if m1:return float(m1.group("num"))*10000.0
    m2=RE_YUAN.search(t)
    if m2:return float(m2.group("num").replace(",",""))
    return None

def msrp_to_yuan_and_jpy(cell:str,rate:float)->str:
    t=strip_any_yen_tokens(clean_price_cell(cell))
    if not t or t in {"-","â€“","â€”"}:return t
    cny=parse_cny(t)
    if cny is None:
        if("å…ƒ"not in t)and RE_WAN.search(t):t=f"{t}å…ƒ"
        return t
    m1=RE_WAN.search(t)
    yuan_disp=f"{m1.group('num')}ä¸‡å…ƒ" if m1 else (t if"å…ƒ"in t else f"{t}å…ƒ")
    jpy=int(round(cny*rate))
    return f"{yuan_disp}ï¼ˆæ—¥æœ¬å††{jpy:,}å††ï¼‰"

def dealer_to_yuan_only(cell:str)->str:
    t=strip_any_yen_tokens(clean_price_cell(cell))
    if not t or t in {"-","â€“","â€”"}:return t
    if("å…ƒ"not in t)and RE_WAN.search(t):t=f"{t}å…ƒ"
    return t

# ====== å›ºå®šè¾æ›¸ï¼ˆæŠ€è¡“æ–‡æ›¸çš„ãªæ—¥æœ¬èªãƒ»CSVãƒ™ãƒ¼ã‚¹ï¼‰ ======
FIX_JA_SECTIONS = {
    "åŸºæœ¬å‚æ•°": "åŸºæœ¬",
    "è½¦èº«": "ãƒœãƒ‡ã‚£",
    "å‘åŠ¨æœº": "ã‚¨ãƒ³ã‚¸ãƒ³",
    "å˜é€Ÿç®±": "ãƒˆãƒ©ãƒ³ã‚¹ãƒŸãƒƒã‚·ãƒ§ãƒ³",
    "åº•ç›˜è½¬å‘": "ã‚·ãƒ£ã‚·ãƒ¼ï¼ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°",
    "è½¦è½®åˆ¶åŠ¨": "ãƒ›ã‚¤ãƒ¼ãƒ«ï¼ãƒ–ãƒ¬ãƒ¼ã‚­",
    "è¢«åŠ¨å®‰å…¨": "å—å‹•å®‰å…¨è£…ç½®",
    "ä¸»åŠ¨å®‰å…¨": "èƒ½å‹•å®‰å…¨è£…ç½®",
    "é©¾é©¶æ“æ§": "ãƒ‰ãƒ©ã‚¤ãƒ“ãƒ³ã‚°ï¼æ“ç¸¦",
    "é©¾é©¶ç¡¬ä»¶": "é‹è»¢æ”¯æ´ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢",
    "é©¾é©¶åŠŸèƒ½": "é‹è»¢æ”¯æ´æ©Ÿèƒ½",
    "å¤–è§‚/é˜²ç›—": "å¤–è£…ï¼é˜²ç›—",
    "è½¦å¤–ç¯å…‰": "è»Šå¤–ç…§æ˜",
    "å¤©çª—/ç»ç’ƒ": "ã‚µãƒ³ãƒ«ãƒ¼ãƒ•ï¼ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦",
    "å¤–åè§†é•œ": "ãƒ‰ã‚¢ãƒŸãƒ©ãƒ¼",
    "å±å¹•/ç³»ç»Ÿ": "ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ï¼è»Šè¼‰ã‚·ã‚¹ãƒ†ãƒ ",
    "æ™ºèƒ½åŒ–é…ç½®": "ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆåŒ–",
    "æ–¹å‘ç›˜/å†…åè§†é•œ": "ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°ï¼ãƒ«ãƒ¼ãƒ ãƒŸãƒ©ãƒ¼",
    "è½¦å†…å……ç”µ": "è»Šå†…å……é›»",
    "åº§æ¤…é…ç½®": "ã‚·ãƒ¼ãƒˆ",
    "éŸ³å“/è½¦å†…ç¯å…‰": "ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªï¼å®¤å†…ç…§æ˜",
    "ç©ºè°ƒ/å†°ç®±": "ç©ºèª¿ï¼å†·è”µ",
    "é¢œè‰²": "ã‚«ãƒ©ãƒ¼",
    "é€‰è£…åŒ…": "ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸",
}

FIX_JA_ITEMS = {
    "å‚å•†æŒ‡å¯¼ä»·": "ãƒ¡ãƒ¼ã‚«ãƒ¼å¸Œæœ›å°å£²ä¾¡æ ¼",
    "å‚å•†æŒ‡å¯¼ä»·(å…ƒ)": "ãƒ¡ãƒ¼ã‚«ãƒ¼å¸Œæœ›å°å£²ä¾¡æ ¼",
    "ç»é”€å•†æŠ¥ä»·": "ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼è²©å£²ä¾¡æ ¼ï¼ˆå…ƒï¼‰",
    "ç»é”€å•†å‚è€ƒä»·": "ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼è²©å£²ä¾¡æ ¼ï¼ˆå…ƒï¼‰",
    "ç»é”€å•†": "ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼è²©å£²ä¾¡æ ¼ï¼ˆå…ƒï¼‰",

    "å‚å•†": "ãƒ¡ãƒ¼ã‚«ãƒ¼",
    "çº§åˆ«": "è»Šæ ¼",
    "èƒ½æºç±»å‹": "ç‡ƒæ–™ç¨®åˆ¥",
    "ç¯ä¿æ ‡å‡†": "æ’å‡ºã‚¬ã‚¹åŸºæº–",
    "ä¸Šå¸‚æ—¶é—´": "ç™ºå£²æ™‚æœŸ",
    "æ•´è½¦è´¨ä¿": "è»Šä¸¡ä¿è¨¼",
    "æ•´å¤‡è´¨é‡(kg)": "è»Šä¸¡é‡é‡ï¼ˆkgï¼‰",
    "æœ€å¤§æ»¡è½½è´¨é‡(kg)": "æœ€å¤§ç·é‡é‡ï¼ˆkgï¼‰",

    "é•¿*å®½*é«˜(mm)": "å…¨é•·Ã—å…¨å¹…Ã—å…¨é«˜ï¼ˆmmï¼‰",
    "é•¿åº¦(mm)": "å…¨é•·ï¼ˆmmï¼‰",
    "å®½åº¦(mm)": "å…¨å¹…ï¼ˆmmï¼‰",
    "é«˜åº¦(mm)": "å…¨é«˜ï¼ˆmmï¼‰",
    "è½´è·(mm)": "ãƒ›ã‚¤ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼ˆmmï¼‰",
    "å‰è½®è·(mm)": "ãƒ•ãƒ­ãƒ³ãƒˆãƒˆãƒ¬ãƒƒãƒ‰ï¼ˆmmï¼‰",
    "åè½®è·(mm)": "ãƒªã‚¢ãƒˆãƒ¬ãƒƒãƒ‰ï¼ˆmmï¼‰",
    "æ¥è¿‘è§’(Â°)": "ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚¢ãƒ³ã‚°ãƒ«ï¼ˆÂ°ï¼‰",
    "ç¦»å»è§’(Â°)": "ãƒ‡ãƒ‘ãƒ¼ãƒãƒ£ãƒ¼ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆÂ°ï¼‰",
    "è½¦èº«ç»“æ„": "ãƒœãƒ‡ã‚£æ§‹é€ ",
    "è½¦é—¨å¼€å¯æ–¹å¼": "ãƒ‰ã‚¢é–‹é–‰æ–¹å¼",
    "è½¦é—¨æ•°(ä¸ª)": "ãƒ‰ã‚¢æ•°ï¼ˆæšï¼‰",
    "åº§ä½æ•°(ä¸ª)": "ä¹—è»Šå®šå“¡ï¼ˆåï¼‰",
    "æ²¹ç®±å®¹ç§¯(L)": "ç‡ƒæ–™ã‚¿ãƒ³ã‚¯å®¹é‡ï¼ˆLï¼‰",
    "åå¤‡å¢å®¹ç§¯(L)": "ãƒ©ã‚²ãƒƒã‚¸å®¹é‡ï¼ˆLï¼‰",
    "é£é˜»ç³»æ•°(Cd)": "ç©ºæ°—æŠµæŠ—ä¿‚æ•°ï¼ˆCdï¼‰",

    "å‘åŠ¨æœº": "ã‚¨ãƒ³ã‚¸ãƒ³",
    "å‘åŠ¨æœºå‹å·": "ã‚¨ãƒ³ã‚¸ãƒ³å‹å¼",
    "æ’é‡(mL)": "ç·æ’æ°—é‡ï¼ˆmLï¼‰",
    "æ’é‡(L)": "ç·æ’æ°—é‡ï¼ˆLï¼‰",
    "è¿›æ°”å½¢å¼": "éçµ¦æ–¹å¼",
    "å‘åŠ¨æœºå¸ƒå±€": "ã‚¨ãƒ³ã‚¸ãƒ³é…ç½®",
    "æ°”ç¼¸æ’åˆ—å½¢å¼": "ã‚·ãƒªãƒ³ãƒ€ãƒ¼é…åˆ—",
    "æ°”ç¼¸æ•°(ä¸ª)": "ã‚·ãƒªãƒ³ãƒ€ãƒ¼æ•°ï¼ˆå€‹ï¼‰",
    "æ¯ç¼¸æ°”é—¨æ•°(ä¸ª)": "1æ°—ç­’å½“ãŸã‚Šãƒãƒ«ãƒ–æ•°ï¼ˆå€‹ï¼‰",
    "é…æ°”æœºæ„": "ãƒãƒ«ãƒ–æ©Ÿæ§‹",
    "æœ€å¤§é©¬åŠ›(Ps)": "æœ€é«˜å‡ºåŠ›ï¼ˆPsï¼‰",
    "æœ€å¤§åŠŸç‡(kW)": "æœ€å¤§å‡ºåŠ›ï¼ˆkWï¼‰",
    "æœ€å¤§åŠŸç‡è½¬é€Ÿ(rpm)": "æœ€å¤§å‡ºåŠ›å›è»¢æ•°ï¼ˆrpmï¼‰",
    "æœ€å¤§æ‰­çŸ©(NÂ·m)": "æœ€å¤§ãƒˆãƒ«ã‚¯ï¼ˆNÂ·mï¼‰",
    "æœ€å¤§æ‰­çŸ©è½¬é€Ÿ(rpm)": "æœ€å¤§ãƒˆãƒ«ã‚¯å›è»¢æ•°ï¼ˆrpmï¼‰",
    "æœ€å¤§å‡€åŠŸç‡(kW)": "æœ€å¤§æ­£å‘³å‡ºåŠ›ï¼ˆkWï¼‰",
    "ç‡ƒæ²¹æ ‡å·": "æ¨å¥¨ç‡ƒæ–™ã‚ªã‚¯ã‚¿ãƒ³ä¾¡",
    "ä¾›æ²¹æ–¹å¼": "ç‡ƒæ–™ä¾›çµ¦æ–¹å¼",
    "ç¼¸ç›–ææ–™": "ã‚·ãƒªãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ‰æè³ª",
    "ç¼¸ä½“ææ–™": "ã‚·ãƒªãƒ³ãƒ€ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯æè³ª",

    "å®˜æ–¹0-100km/håŠ é€Ÿ(s)": "0-100km/håŠ é€Ÿï¼ˆå…¬å¼ï¼‰ï¼ˆsï¼‰",
    "æœ€é«˜è½¦é€Ÿ(km/h)": "æœ€é«˜é€Ÿåº¦ï¼ˆkm/hï¼‰",
    "WLTCç»¼åˆæ²¹è€—(L/100km)": "WLTCç·åˆç‡ƒè²»ï¼ˆL/100kmï¼‰",

    "ç®€ç§°": "ç•¥ç§°",
    "æŒ¡ä½ä¸ªæ•°": "æ®µæ•°",
    "å˜é€Ÿç®±": "ãƒˆãƒ©ãƒ³ã‚¹ãƒŸãƒƒã‚·ãƒ§ãƒ³",
    "å˜é€Ÿç®±ç±»å‹": "ãƒˆãƒ©ãƒ³ã‚¹ãƒŸãƒƒã‚·ãƒ§ãƒ³å½¢å¼",

    "é©±åŠ¨æ–¹å¼": "é§†å‹•æ–¹å¼",
    "å››é©±å½¢å¼": "å››è¼ªé§†å‹•æ–¹å¼",
    "ä¸­å¤®å·®é€Ÿå™¨ç»“æ„": "ã‚»ãƒ³ã‚¿ãƒ¼ãƒ‡ãƒ•æ§‹é€ ",
    "å‰æ‚¬æ¶ç±»å‹": "ãƒ•ãƒ­ãƒ³ãƒˆã‚µã‚¹ãƒšãƒ³ã‚·ãƒ§ãƒ³å½¢å¼",
    "åæ‚¬æ¶ç±»å‹": "ãƒªã‚¢ã‚µã‚¹ãƒšãƒ³ã‚·ãƒ§ãƒ³å½¢å¼",
    "åŠ©åŠ›ç±»å‹": "ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°ã‚¢ã‚·ã‚¹ãƒˆæ–¹å¼",
    "è½¦ä½“ç»“æ„": "ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹é€ ",

    "å‰åˆ¶åŠ¨å™¨ç±»å‹": "ãƒ•ãƒ­ãƒ³ãƒˆãƒ–ãƒ¬ãƒ¼ã‚­å½¢å¼",
    "ååˆ¶åŠ¨å™¨ç±»å‹": "ãƒªã‚¢ãƒ–ãƒ¬ãƒ¼ã‚­å½¢å¼",
    "é©»è½¦åˆ¶åŠ¨ç±»å‹": "ãƒ‘ãƒ¼ã‚­ãƒ³ã‚°ãƒ–ãƒ¬ãƒ¼ã‚­å½¢å¼",
    "å‰è½®èƒè§„æ ¼": "ãƒ•ãƒ­ãƒ³ãƒˆã‚¿ã‚¤ãƒ¤ã‚µã‚¤ã‚º",
    "åè½®èƒè§„æ ¼": "ãƒªã‚¢ã‚¿ã‚¤ãƒ¤ã‚µã‚¤ã‚º",
    "å¤‡èƒè§„æ ¼": "ã‚¹ãƒšã‚¢ã‚¿ã‚¤ãƒ¤ä»•æ§˜",

    "ä¸»/å‰¯é©¾é©¶åº§å®‰å…¨æ°”å›Š": "é‹è»¢å¸­ï¼åŠ©æ‰‹å¸­ã‚¨ã‚¢ãƒãƒƒã‚°",
    "å‰/åæ’ä¾§æ°”å›Š": "å‰å¸­ï¼å¾Œå¸­ã‚µã‚¤ãƒ‰ã‚¨ã‚¢ãƒãƒƒã‚°",
    "å‰/åæ’å¤´éƒ¨æ°”å›Š(æ°”å¸˜)": "å‰å¾Œå¸­ã‚«ãƒ¼ãƒ†ãƒ³ã‚¨ã‚¢ãƒãƒƒã‚°",
    "è†éƒ¨æ°”å›Š": "ãƒ‹ãƒ¼ã‚¨ã‚¢ãƒãƒƒã‚°",
    "å‰æ’ä¸­é—´æ°”å›Š": "å‰å¸­ã‚»ãƒ³ã‚¿ãƒ¼ã‚¨ã‚¢ãƒãƒƒã‚°",
    "è¢«åŠ¨è¡Œäººä¿æŠ¤": "æ­©è¡Œè€…ä¿è­·ï¼ˆå—å‹•ï¼‰",

    "ABSé˜²æŠ±æ­»": "ABSï¼ˆã‚¢ãƒ³ãƒãƒ­ãƒƒã‚¯ãƒ–ãƒ¬ãƒ¼ã‚­ï¼‰",
    "åˆ¶åŠ¨åŠ›åˆ†é…(EBD/CBCç­‰)": "åˆ¶å‹•åŠ›é…åˆ†ï¼ˆEBD/CBCç­‰ï¼‰",
    "åˆ¹è½¦è¾…åŠ©(EBA/BAS/BAç­‰)": "ãƒ–ãƒ¬ãƒ¼ã‚­ã‚¢ã‚·ã‚¹ãƒˆï¼ˆEBA/BAS/BAç­‰ï¼‰",
    "ç‰µå¼•åŠ›æ§åˆ¶(ASR/TCS/TRCç­‰)": "ãƒˆãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆASR/TCS/TRCç­‰ï¼‰",
    "è½¦èº«ç¨³å®šæ§åˆ¶(ESC/ESP/DSCç­‰)": "è»Šä¸¡å®‰å®šåˆ¶å¾¡ï¼ˆESC/ESP/DSCç­‰ï¼‰",
    "èƒå‹ç›‘æµ‹åŠŸèƒ½": "ã‚¿ã‚¤ãƒ¤ç©ºæ°—åœ§ç›£è¦–",
    "å®‰å…¨å¸¦æœªç³»æé†’": "ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆéè£…ç€è­¦å ±",
    "ISOFIXå„¿ç«¥åº§æ¤…æ¥å£": "ISOFIXãƒãƒ£ã‚¤ãƒ«ãƒ‰ã‚·ãƒ¼ãƒˆå›ºå®šå…·",

    "å‰/åé©»è½¦é›·è¾¾": "å‰å¾Œãƒ‘ãƒ¼ã‚­ãƒ³ã‚°ã‚»ãƒ³ã‚µãƒ¼",
    "é©¾é©¶è¾…åŠ©å½±åƒ": "å‘¨å›²ç›£è¦–ã‚«ãƒ¡ãƒ©",
    "å‰æ–¹æ„ŸçŸ¥æ‘„åƒå¤´": "å‰æ–¹æ¤œçŸ¥ã‚«ãƒ¡ãƒ©",
    "æ‘„åƒå¤´æ•°é‡": "ã‚«ãƒ¡ãƒ©æ•°",
    "è½¦å†…æ‘„åƒå¤´æ•°é‡": "è»Šå†…ã‚«ãƒ¡ãƒ©æ•°",
    "è¶…å£°æ³¢é›·è¾¾æ•°é‡": "è¶…éŸ³æ³¢ã‚»ãƒ³ã‚µãƒ¼æ•°",

    "å·¡èˆªç³»ç»Ÿ": "ã‚¯ãƒ«ãƒ¼ã‚ºåˆ¶å¾¡",
    "è¾…åŠ©é©¾é©¶ç­‰çº§": "é‹è»¢æ”¯æ´ãƒ¬ãƒ™ãƒ«",
    "å«æ˜Ÿå¯¼èˆªç³»ç»Ÿ": "ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ",
    "å¯¼èˆªè·¯å†µä¿¡æ¯æ˜¾ç¤º": "äº¤é€šæƒ…å ±è¡¨ç¤º",
    "åœ°å›¾å“ç‰Œ": "åœ°å›³ãƒ–ãƒ©ãƒ³ãƒ‰",
    "ARå®æ™¯å¯¼èˆª": "ARå®Ÿå†™ãƒŠãƒ“",
    "å¹¶çº¿è¾…åŠ©": "è»Šç·šå¤‰æ›´æ”¯æ´",
    "è½¦é“ä¿æŒè¾…åŠ©ç³»ç»Ÿ": "è»Šç·šç¶­æŒæ”¯æ´",
    "è½¦é“åç¦»é¢„è­¦ç³»ç»Ÿ": "è»Šç·šé€¸è„±è­¦å ±",
    "è½¦é“å±…ä¸­ä¿æŒ": "è»Šç·šä¸­å¤®ç¶­æŒ",
    "é“è·¯äº¤é€šæ ‡è¯†è¯†åˆ«": "äº¤é€šæ¨™è­˜èªè­˜",
    "ä¸»åŠ¨åˆ¹è½¦/ä¸»åŠ¨å®‰å…¨ç³»ç»Ÿ": "è‡ªå‹•ç·Šæ€¥ãƒ–ãƒ¬ãƒ¼ã‚­ï¼ˆAEBï¼‰",
    "ç–²åŠ³é©¾é©¶æç¤º": "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ç–²åŠ¥è­¦å ±",
    "å‰æ–¹ç¢°æ’é¢„è­¦": "å‰æ–¹è¡çªè­¦å ±",
    "å†…ç½®è¡Œè½¦è®°å½•ä»ª": "ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼å†…è”µ",
    "é“è·¯æ•‘æ´å‘¼å«": "ãƒ­ãƒ¼ãƒ‰ã‚¢ã‚·ã‚¹ãƒˆã‚³ãƒ¼ãƒ«",
    "è¾…åŠ©æ³Šè½¦å…¥ä½": "é§è»Šæ”¯æ´ã‚·ã‚¹ãƒ†ãƒ ",
    "è¾…åŠ©å˜é“": "è‡ªå‹•è»Šç·šå¤‰æ›´æ”¯æ´",
    "è¾…åŠ©åŒé“è‡ªåŠ¨é©¶å‡º(å…¥)": "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒã‚§ãƒ³ã‚¸å‡ºå…¥æ”¯æ´",
    "è¾…åŠ©é©¾é©¶è·¯æ®µ": "æ”¯æ´å¯¾å¿œè·¯ç¨®",
    "é©¾é©¶æ¨¡å¼åˆ‡æ¢": "ãƒ‰ãƒ©ã‚¤ãƒ“ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿",
    "å‘åŠ¨æœºå¯åœæŠ€æœ¯": "ã‚¢ã‚¤ãƒ‰ãƒªãƒ³ã‚°ã‚¹ãƒˆãƒƒãƒ—",
    "è‡ªåŠ¨é©»è½¦": "ã‚ªãƒ¼ãƒˆãƒ›ãƒ¼ãƒ«ãƒ‰",
    "ä¸Šå¡è¾…åŠ©": "ãƒ’ãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ã‚·ã‚¹ãƒˆ",
    "å¯å˜æ‚¬æ¶åŠŸèƒ½": "å¯å¤‰ã‚µã‚¹ãƒšãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½",
    "å¯å˜è½¬å‘æ¯”": "å¯å¤‰ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°æ¯”",

    "å¤–è§‚å¥—ä»¶": "ã‚¨ã‚¯ã‚¹ãƒ†ãƒªã‚¢ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸",
    "è¿åŠ¨é£æ ¼": "ã‚¹ãƒãƒ¼ãƒ„ã‚¹ã‚¿ã‚¤ãƒ«",
    "è½®åœˆæè´¨": "ãƒ›ã‚¤ãƒ¼ãƒ«æè³ª",
    "ç”µåŠ¨åå¤‡å¢": "é›»å‹•ãƒ†ãƒ¼ãƒ«ã‚²ãƒ¼ãƒˆ",
    "æ„Ÿåº”åå¤‡å¢": "ãƒãƒ³ã‚ºãƒ•ãƒªãƒ¼ãƒ†ãƒ¼ãƒ«ã‚²ãƒ¼ãƒˆ",
    "ç”µåŠ¨åå¤‡å¢ä½ç½®è®°å¿†": "ãƒ†ãƒ¼ãƒ«ã‚²ãƒ¼ãƒˆé–‹åº¦è¨˜æ†¶",
    "å‘åŠ¨æœºç”µå­é˜²ç›—": "ã‚¨ãƒ³ã‚¸ãƒ³ã‚¤ãƒ¢ãƒ“ãƒ©ã‚¤ã‚¶ãƒ¼",
    "è½¦å†…ä¸­æ§é”": "é›†ä¸­ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯",
    "é’¥åŒ™ç±»å‹": "ã‚­ãƒ¼ã‚¿ã‚¤ãƒ—",
    "æ— é’¥åŒ™å¯åŠ¨ç³»ç»Ÿ": "ã‚­ãƒ¼ãƒ¬ã‚¹å§‹å‹•ã‚·ã‚¹ãƒ†ãƒ ",
    "æ— é’¥åŒ™è¿›å…¥åŠŸèƒ½": "ã‚­ãƒ¼ãƒ¬ã‚¹ã‚¨ãƒ³ãƒˆãƒªãƒ¼",
    "éšè—ç”µåŠ¨é—¨æŠŠæ‰‹": "æ ¼ç´å¼ãƒ‰ã‚¢ãƒãƒ³ãƒ‰ãƒ«",
    "è¿œç¨‹å¯åŠ¨åŠŸèƒ½": "ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ã‚¿ãƒ¼ãƒˆ",

    "è¿‘å…‰ç¯å…‰æº": "ãƒ­ãƒ¼ãƒ“ãƒ¼ãƒ å…‰æº",
    "è¿œå…‰ç¯å…‰æº": "ãƒã‚¤ãƒ“ãƒ¼ãƒ å…‰æº",
    "ç¯å…‰ç‰¹è‰²åŠŸèƒ½": "ãƒ©ã‚¤ãƒˆç‰¹åˆ¥æ©Ÿèƒ½",
    "LEDæ—¥é—´è¡Œè½¦ç¯": "LEDãƒ‡ã‚¤ã‚¿ã‚¤ãƒ ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ãƒ©ã‚¤ãƒˆ",
    "è‡ªé€‚åº”è¿œè¿‘å…‰": "ã‚¢ãƒ€ãƒ—ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ“ãƒ¼ãƒ ",
    "è‡ªåŠ¨å¤´ç¯": "ã‚ªãƒ¼ãƒˆãƒ©ã‚¤ãƒˆ",
    "è½¬å‘å¤´ç¯": "ã‚³ãƒ¼ãƒŠãƒªãƒ³ã‚°ãƒ©ã‚¤ãƒˆ",
    "è½¦å‰é›¾ç¯": "ãƒ•ãƒ­ãƒ³ãƒˆãƒ•ã‚©ã‚°ãƒ©ãƒ³ãƒ—",
    "å¤§ç¯é«˜åº¦å¯è°ƒ": "ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒˆãƒ¬ãƒ™ãƒ©ã‚¤ã‚¶ãƒ¼",
    "å¤§ç¯å»¶æ—¶å…³é—­": "ãƒ©ã‚¤ãƒˆã‚ªãƒ•ãƒ‡ã‚£ãƒ¬ã‚¤",

    "å¤©çª—ç±»å‹": "ã‚µãƒ³ãƒ«ãƒ¼ãƒ•å½¢å¼",
    "å‰/åç”µåŠ¨è½¦çª—": "å‰å¾Œãƒ‘ãƒ¯ãƒ¼ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦",
    "è½¦çª—ä¸€é”®å‡é™åŠŸèƒ½": "ãƒ¯ãƒ³ã‚¿ãƒƒãƒã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦",
    "è½¦çª—é˜²å¤¹æ‰‹åŠŸèƒ½": "æŒŸã¿è¾¼ã¿é˜²æ­¢æ©Ÿæ§‹",
    "ä¾§çª—å¤šå±‚éš”éŸ³ç»ç’ƒ": "å¤šå±¤é®éŸ³ã‚¬ãƒ©ã‚¹ï¼ˆã‚µã‚¤ãƒ‰ï¼‰",
    "åé£æŒ¡é®é˜³å¸˜": "ãƒªã‚¢ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚µãƒ³ã‚·ã‚§ãƒ¼ãƒ‰",
    "åæ’ä¾§çª—é®é˜³å¸˜": "å¾Œå¸­ã‚µã‚¤ãƒ‰ã‚µãƒ³ã‚·ã‚§ãƒ¼ãƒ‰",
    "è½¦å†…åŒ–å¦†é•œ": "ãƒãƒ‹ãƒ†ã‚£ãƒŸãƒ©ãƒ¼",
    "åé›¨åˆ·": "ãƒªã‚¢ãƒ¯ã‚¤ãƒ‘ãƒ¼",
    "æ„Ÿåº”é›¨åˆ·åŠŸèƒ½": "ãƒ¬ã‚¤ãƒ³ã‚»ãƒ³ã‚µãƒ¼",

    "å¤–åè§†é•œåŠŸèƒ½": "ãƒ‰ã‚¢ãƒŸãƒ©ãƒ¼æ©Ÿèƒ½",

    "ä¸­æ§å½©è‰²å±å¹•": "ã‚»ãƒ³ã‚¿ãƒ¼ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤",
    "ä¸­æ§å±å¹•å°ºå¯¸": "ã‚»ãƒ³ã‚¿ãƒ¼ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚µã‚¤ã‚º",
    "å‰¯é©¾å¨±ä¹å±å°ºå¯¸": "åŠ©æ‰‹å¸­ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚µã‚¤ã‚º",
    "è“ç‰™/è½¦è½½ç”µè¯": "Bluetoothï¼è»Šè¼‰é›»è©±",
    "æ‰‹æœºäº’è”/æ˜ å°„": "ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³é€£æºï¼ãƒŸãƒ©ãƒ¼ãƒªãƒ³ã‚°",
    "è¯­éŸ³è¯†åˆ«æ§åˆ¶ç³»ç»Ÿ": "éŸ³å£°èªè­˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«",
    "è¯­éŸ³åŠ©æ‰‹å”¤é†’è¯": "éŸ³å£°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆèµ·å‹•èª",
    "è¯­éŸ³å…å”¤é†’è¯": "ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹éŸ³å£°æ“ä½œ",
    "è¯­éŸ³åˆ†åŒºåŸŸå”¤é†’è¯†åˆ«": "ã‚¨ãƒªã‚¢åˆ¥éŸ³å£°èµ·å‹•èªè­˜",
    "è¯­éŸ³è¿ç»­è¯†åˆ«": "é€£ç¶šéŸ³å£°èªè­˜",
    "å¯è§å³å¯è¯´": "è¦–è¦šé€£å‹•éŸ³å£°æ“ä½œ",
    "æ‰‹åŠ¿æ§åˆ¶": "ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«",
    "åº”ç”¨å•†åº—": "ã‚¢ãƒ—ãƒªã‚¹ãƒˆã‚¢",
    "è½¦è½½æ™ºèƒ½ç³»ç»Ÿ": "è»Šè¼‰OSï¼ã‚¤ãƒ³ãƒ•ã‚©ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆ",
    "è½¦æœºæ™ºèƒ½èŠ¯ç‰‡": "è»Šè¼‰SoC",

    "è½¦è”ç½‘": "è»Šè¼‰é€šä¿¡ï¼ˆã‚³ãƒã‚¯ãƒ†ãƒƒãƒ‰ï¼‰",
    "4G/5Gç½‘ç»œ": "4G/5Gé€šä¿¡",
    "OTAå‡çº§": "OTAã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ",
    "V2Xé€šè®¯": "V2Xé€šä¿¡",
    "æ‰‹æœºAPPè¿œç¨‹åŠŸèƒ½": "ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªé éš”æ©Ÿèƒ½",

    "æ–¹å‘ç›˜æè´¨": "ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°æè³ª",
    "æ–¹å‘ç›˜ä½ç½®è°ƒèŠ‚": "ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°ä½ç½®èª¿æ•´",
    "æ¢æŒ¡å½¢å¼": "ã‚·ãƒ•ãƒˆå½¢å¼",
    "å¤šåŠŸèƒ½æ–¹å‘ç›˜": "ãƒãƒ«ãƒãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°",
    "æ–¹å‘ç›˜æ¢æŒ¡æ‹¨ç‰‡": "ãƒ‘ãƒ‰ãƒ«ã‚·ãƒ•ãƒˆ",
    "æ–¹å‘ç›˜åŠ çƒ­": "ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°ãƒ’ãƒ¼ã‚¿ãƒ¼",
    "æ–¹å‘ç›˜è®°å¿†": "ã‚¹ãƒ†ã‚¢ãƒªãƒ³ã‚°ãƒ¡ãƒ¢ãƒªãƒ¼",
    "è¡Œè½¦ç”µè„‘æ˜¾ç¤ºå±å¹•": "ãƒ‰ãƒ©ã‚¤ãƒ–ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿è¡¨ç¤º",
    "å…¨æ¶²æ™¶ä»ªè¡¨ç›˜": "ãƒ•ãƒ«æ¶²æ™¶ãƒ¡ãƒ¼ã‚¿ãƒ¼ãƒ‘ãƒãƒ«",
    "æ¶²æ™¶ä»ªè¡¨å°ºå¯¸": "ãƒ¡ãƒ¼ã‚¿ãƒ¼æ¶²æ™¶ã‚µã‚¤ã‚º",
    "HUDæŠ¬å¤´æ•°å­—æ˜¾ç¤º": "ãƒ˜ãƒƒãƒ‰ã‚¢ãƒƒãƒ—ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ï¼ˆHUDï¼‰",
    "å†…åè§†é•œåŠŸèƒ½": "ãƒ«ãƒ¼ãƒ ãƒŸãƒ©ãƒ¼æ©Ÿèƒ½",
    "ETCè£…ç½®": "ETCè£…ç½®",

    "å¤šåª’ä½“/å……ç”µæ¥å£": "ãƒãƒ«ãƒãƒ¡ãƒ‡ã‚£ã‚¢ï¼å……é›»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹",
    "USB/Type-Cæ¥å£æ•°é‡": "USB/Type-Cãƒãƒ¼ãƒˆæ•°",
    "æ‰‹æœºæ— çº¿å……ç”µåŠŸèƒ½": "ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãƒ¯ã‚¤ãƒ¤ãƒ¬ã‚¹å……é›»",

    "åº§æ¤…æè´¨": "ã‚·ãƒ¼ãƒˆæè³ª",
    "ä¸»åº§æ¤…è°ƒèŠ‚æ–¹å¼": "é‹è»¢å¸­èª¿æ•´æ–¹å¼",
    "å‰¯åº§æ¤…è°ƒèŠ‚æ–¹å¼": "åŠ©æ‰‹å¸­èª¿æ•´æ–¹å¼",
    "ä¸»/å‰¯é©¾é©¶åº§ç”µåŠ¨è°ƒèŠ‚": "é‹è»¢å¸­ï¼åŠ©æ‰‹å¸­é›»å‹•èª¿æ•´",
    "å‰æ’åº§æ¤…åŠŸèƒ½": "å‰å¸­ã‚·ãƒ¼ãƒˆæ©Ÿèƒ½",
    "ç”µåŠ¨åº§æ¤…è®°å¿†åŠŸèƒ½": "é›»å‹•ã‚·ãƒ¼ãƒˆãƒ¡ãƒ¢ãƒªãƒ¼",
    "å‰¯é©¾é©¶ä½åæ’å¯è°ƒèŠ‚æŒ‰é’®": "åŠ©æ‰‹å¸­å¾Œå¸­èª¿æ•´ãƒœã‚¿ãƒ³",
    "ç¬¬äºŒæ’åº§æ¤…è°ƒèŠ‚": "å¾Œå¸­èª¿æ•´æ©Ÿèƒ½",
    "ç¬¬äºŒæ’åº§æ¤…ç”µåŠ¨è°ƒèŠ‚": "å¾Œå¸­é›»å‹•èª¿æ•´",
    "ç¬¬äºŒæ’åº§æ¤…åŠŸèƒ½": "å¾Œå¸­ã‚·ãƒ¼ãƒˆæ©Ÿèƒ½",
    "åæ’åº§æ¤…æ”¾å€’å½¢å¼": "å¾Œå¸­å¯å€’æ–¹å¼",
    "å‰/åä¸­å¤®æ‰¶æ‰‹": "å‰å¾Œã‚»ãƒ³ã‚¿ãƒ¼ã‚¢ãƒ¼ãƒ ãƒ¬ã‚¹ãƒˆ",
    "åæ’æ¯æ¶": "å¾Œå¸­ã‚«ãƒƒãƒ—ãƒ›ãƒ«ãƒ€ãƒ¼",

    "æ‰¬å£°å™¨å“ç‰Œåç§°": "ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒ–ãƒ©ãƒ³ãƒ‰",
    "æ‰¬å£°å™¨æ•°é‡": "ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼æ•°",
    "æœæ¯”å…¨æ™¯å£°(Dolby Atmos)": "Dolby Atmos",
    "è½¦å†…ç¯å¢ƒæ°›å›´ç¯": "ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆãƒ©ã‚¤ãƒˆ",
    "ä¸»åŠ¨å¼ç¯å¢ƒæ°›å›´ç¯": "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆãƒ©ã‚¤ãƒˆ",

    "ç©ºè°ƒæ¸©åº¦æ§åˆ¶æ–¹å¼": "ç©ºèª¿æ¸©åº¦åˆ¶å¾¡æ–¹å¼",
    "åæ’ç‹¬ç«‹ç©ºè°ƒ": "å¾Œå¸­ç‹¬ç«‹ç©ºèª¿",
    "ååº§å‡ºé£å£": "å¾Œå¸­ã‚¨ã‚¢ã‚¢ã‚¦ãƒˆãƒ¬ãƒƒãƒˆ",
    "æ¸©åº¦åˆ†åŒºæ§åˆ¶": "æ¸©åº¦ç‹¬ç«‹èª¿æ•´ï¼ˆã‚¾ãƒ¼ãƒ³ï¼‰",
    "è½¦è½½ç©ºæ°”å‡€åŒ–å™¨": "è»Šè¼‰ç©ºæ°—æ¸…æµ„æ©Ÿ",
    "è½¦å†…PM2.5è¿‡æ»¤è£…ç½®": "è»Šå†…PM2.5ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼",
    "ç©ºæ°”è´¨é‡ç›‘æµ‹": "ç©ºæ°—è³ªãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°",

    "å¤–è§‚é¢œè‰²": "å¤–è£…è‰²",
    "å†…é¥°é¢œè‰²": "å†…è£…è‰²",
    "æ™ºäº«å¥—è£…2": "ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒ•ã‚©ãƒ¼ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸2",
    "æ™ºèƒ½é¢†èˆªè¾…åŠ©Max": "ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚·ã‚¹ãƒˆMax",
    "æ™ºä¹å¥—è£…": "ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸",
}

PRICE_ITEM_MSRP_CN={"å‚å•†æŒ‡å¯¼ä»·","å‚å•†æŒ‡å¯¼ä»·(å…ƒ)"}
PRICE_ITEM_MSRP_JA={"ãƒ¡ãƒ¼ã‚«ãƒ¼å¸Œæœ›å°å£²ä¾¡æ ¼"}
PRICE_ITEM_DEALER_CN={"ç»é”€å•†å‚è€ƒä»·","ç»é”€å•†æŠ¥ä»·","ç»é”€å•†"}
PRICE_ITEM_DEALER_JA={"ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼è²©å£²ä¾¡æ ¼ï¼ˆå…ƒï¼‰"}

# ====== LLMï¼ˆä¸è¶³åˆ†ã®ã¿ï¼‰ ======
def parse_json_relaxed(content:str,terms:list[str])->dict[str,str]:
    try:
        d=json.loads(content)
        if isinstance(d,dict)and"translations"in d:
            return {str(t["cn"]).strip():str(t.get("ja",t["cn"])).strip()
                    for t in d["translations"] if t.get("cn")}
    except Exception:
        pass
    pairs=re.findall(r'"cn"\s*:\s*"([^"]+)"\s*,\s*"ja"\s*:\s*"([^"]*)"', content)
    if pairs:
        return {cn.strip():ja.strip() for cn,ja in pairs}
    return {t:t for t in terms}

class Translator:
    def __init__(self, model: str, api_key: str):
        if not (api_key and api_key.strip()):
            raise RuntimeError("OPENAI_API_KEY is not set")
        self.client = OpenAI(api_key=api_key)
        self.model = model
        self.system = (
            "ã‚ãªãŸã¯è‡ªå‹•è»Šä»•æ§˜è¡¨ã®å°‚é–€ç¿»è¨³è€…ã§ã™ã€‚"
            "å…¥åŠ›ã¯ä¸­å›½èªã®ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³å/é …ç›®åã€é…åˆ—ã€‚"
            "æŠ€è¡“æ–‡æ›¸çš„ãªæ—¥æœ¬èªã«ç¿»è¨³ã€‚å˜ä½ãƒ»è¨˜å·ã¯ä¿æŒã€‚"
            "å‡ºåŠ›ã¯ JSONï¼ˆ{'translations':[{'cn':'åŸæ–‡','ja':'è¨³æ–‡'}]}ï¼‰ã®ã¿ã€‚"
        )

    def translate_batch(self, terms: list[str]) -> dict[str,str]:
        if not terms:
            return {}
        msgs=[
            {"role":"system","content":self.system},
            {"role":"user","content":json.dumps({"terms":terms},ensure_ascii=False)},
        ]
        resp=self.client.chat.completions.create(
            model=self.model,messages=msgs,temperature=0,
            response_format={"type":"json_object"},
        )
        content=resp.choices[0].message.content or ""
        return parse_json_relaxed(content, terms)

def batch(iterable, n=60):
    it=list(iterable)
    for i in range(0,len(it),n):
        yield it[i:i+n]

# ====== main ======
def main():
    print(f"SRC: {SRC}")
    print(f"DST (primary): {DST_PRIMARY}")
    print(f"DST (secondary): {DST_SECONDARY}")

    if not Path(SRC).exists():
        raise FileNotFoundError(f"å…¥åŠ›CSVãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {SRC}")

    df_cn = pd.read_csv(SRC, encoding="utf-8-sig")

    # åˆ—åï¼ˆå…ˆé ­2åˆ—ã¯ 'ã‚»ã‚¯ã‚·ãƒ§ãƒ³','é …ç›®' ã‚’å‰æï¼‰
    cols=list(df_cn.columns)

    # ã‚»ã‚¯ã‚·ãƒ§ãƒ³/é …ç›®ã®è¾æ›¸å„ªå…ˆãƒãƒƒãƒ—ã‚’æ§‹ç¯‰
    sec_cn = df_cn.iloc[:,0].fillna("").astype(str)
    item_cn= df_cn.iloc[:,1].fillna("").astype(str)

    uniq_sec  = sorted({s.strip() for s in sec_cn if s.strip()})
    uniq_item = sorted({s.strip() for s in item_cn if s.strip()})

    sec_missing  = [x for x in uniq_sec  if x not in FIX_JA_SECTIONS]
    item_missing = [x for x in uniq_item if x not in FIX_JA_ITEMS]

    sec_add, item_add = {}, {}
    if (sec_missing or item_missing) and API_KEY:
        tr=Translator(MODEL, API_KEY)
        for chunk in batch(sec_missing, BATCH_SIZE):
            sec_add.update(tr.translate_batch(chunk))
            time.sleep(SLEEP_BASE)
        for chunk in batch(item_missing, BATCH_SIZE):
            item_add.update(tr.translate_batch(chunk))
            time.sleep(SLEEP_BASE)

    sec_map  = {**FIX_JA_SECTIONS, **sec_add}
    item_map = {**FIX_JA_ITEMS,    **item_add}

    # å’Œè¨³åˆ—ã®ç”Ÿæˆï¼ˆè¾æ›¸å„ªå…ˆï¼‰
    sec_ja  = [sec_map.get(x,x) for x in sec_cn]
    item_ja = [item_map.get(x,x) for x in item_cn]

    df = df_cn.copy()
    df.insert(0, "é …ç›®_ja", item_ja)
    df.insert(0, "ã‚»ã‚¯ã‚·ãƒ§ãƒ³_ja", sec_ja)

    # ä¾¡æ ¼æ•´å½¢ï¼ˆå…ƒã®åˆ—åã¯ãã®ã¾ã¾ã€å€¤ã ã‘æ•´å½¢ï¼‰
    for r in range(len(df)):
        item = str(df.iloc[r,2])  # å…ƒã®ã€Œé …ç›®ã€åˆ—ï¼ˆæŒ¿å…¥ã«ã‚ˆã‚Š+2ï¼‰
        if item in PRICE_ITEM_MSRP_CN or item in PRICE_ITEM_MSRP_JA:
            for c in range(3, len(df.columns)):
                df.iat[r,c] = msrp_to_yuan_and_jpy(df.iat[r,c], EXRATE_CNY_TO_JPY)
        if item in PRICE_ITEM_DEALER_CN or item in PRICE_ITEM_DEALER_JA:
            for c in range(3, len(df.columns)):
                df.iat[r,c] = dealer_to_yuan_only(df.iat[r,c])

    # ã‚°ãƒ¬ãƒ¼ãƒ‰åˆ—ã¯ä¸€åˆ‡åŠ å·¥ã—ãªã„
    out_full=df

    # å‡ºåŠ›ï¼ˆprimary ã¯ãã®ã¾ã¾, secondary ã¯ .ja ã¨ _ja ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
    DST_PRIMARY.parent.mkdir(parents=True, exist_ok=True)
    out_full.to_csv(DST_PRIMARY, index=False, encoding="utf-8-sig")
    out_full.to_csv(DST_SECONDARY, index=False, encoding="utf-8-sig")

    # ãƒªãƒã‚¸ãƒˆãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥
    cn_snap_path = Path(CACHE_REPO_DIR) / "config_cn_snapshot.csv"
    ja_prev_path = Path(CACHE_REPO_DIR) / "config_ja_prev.csv"

    cn_snap_path.parent.mkdir(parents=True, exist_ok=True)
    pd.read_csv(SRC, encoding="utf-8-sig").to_csv(cn_snap_path, index=False, encoding="utf-8-sig")
    out_full.to_csv(ja_prev_path, index=False, encoding="utf-8-sig")

    print(f"âœ… Saved: {DST_PRIMARY}")
    print(f"âœ… Saved (alt): {DST_SECONDARY}")
    print(f"ğŸ“¦ Repo cache CN: {cn_snap_path}")
    print(f"ğŸ“¦ Repo cache JA: {ja_prev_path}")

if __name__ == "__main__":
    main()
