name: monthly-rank-playwright

on:
  workflow_dispatch:
  schedule:
    - cron: "0 21 10 * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: setup-python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: install-dependencies
        run: |
          pip install -r requirements.txt
          playwright install --with-deps

      - name: fetch-autohome-rank-data
        run: |
          python tools/autohome_rank_playwright.py

      - name: append-and-enrich-with-llm-translate
        env:
          # Secret名を「GEMENI」に修正しました
          GEMINI_API_KEY: ${{ secrets.GEMENI }}
        run: |
          python tools/translate_brand_model_llm.py data/latest_autohome_rank.csv data/latest_autohome_rank_enriched.csv

      - name: update-vlm-data-and-commit
        run: |
          python vlm_rank_reader.py
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git diff --staged --quiet || git commit -m "auto: append + enrich + LLM translate (updated or missing_ja.csv)"
          git push
