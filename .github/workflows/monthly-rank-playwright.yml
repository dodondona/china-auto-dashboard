name: run

on:
  workflow_dispatch:
  schedule:
    - cron: "15 1 * * *"  # 任意

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests beautifulsoup4 lxml playwright
          # ← ここが重要（毎回クリーン環境）
          python -m playwright install --with-deps chromium

      # ====== 1) series_url の付与 ======
      - name: Append series_url from /rank/
        run: |
          set -euo pipefail

          # 対象CSV一覧（存在チェックをしつつ回す）
          for f in data/autohome_raw_*.csv; do
            [ -e "$f" ] || continue
            base="${f%.csv}"
            out="${base}_with_series.csv"

            echo "▶ $(basename "$f") -> $(basename "$out")"
            python tools/append_series_url_from_web.force_dom.py \
              --input "$f" \
              --output "$out" \
              --rank-url "https://www.autohome.com.cn/rank/1-3-1071-x/"
          done

      # ====== 2) 以降の処理（元のまま・失敗しない呼び方に） ======
      # ここはあなたの他ツールと整合するように、未対応オプションを渡さないで実行してください。
      - name: Enrich brand/model from <title>
        run: |
          set -euo pipefail
          # 例: 未対応フラグを渡さない安全運転の呼び方（スクリプトに合わせて変更）
          for f in data/autohome_raw_*_with_series.csv; do
            [ -e "$f" ] || continue
            base="${f%_with_series.csv}"
            out="${base}_with_brand.csv"
            python tools/enrich_brand_model_from_title.py \
              --input "$f" \
              --output "$out"
          done

      - name: Translate brand/model to global names (no cache)
        run: |
          set -euo pipefail
          # あなたの translate_* スクリプトが受け付ける引数のみ使用（未対応の --cache, --use-wikidata などは渡さない）
          for f in data/autohome_raw_*_with_brand.csv; do
            [ -e "$f" ] || continue
            out="${f%_with_brand.csv}_with_brand_ja.csv"
            echo "Translating: $f -> $out"
            python tools/translate_brand_model_llm.py \
              --input "$f" \
              --output "$out" \
              --brand-col brand \
              --model-col model \
              --brand-ja-col brand_ja \
              --model-ja-col model_ja \
              --model "gpt-4o-mini"  # 例: スクリプトが受理する既存パラメータのみ
          done

      - name: Commit artifacts
        if: success()
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "auto: append series_url + enrich + translate (no cache, robust merge)" || true
          git push || true
