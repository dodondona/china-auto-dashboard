name: Monthly append series_url & enrich brand/series (rank/1 + global translation)

on:
  workflow_dispatch:
  schedule:
    - cron: "15 1 2 * *"  # 毎月2日01:15 UTC（北京時間午前9:15）

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install openai google-api-python-client wikipedia-api pandas requests

      # ================================================================
      # 1️⃣ Append series_url from /rank/ pages
      # ================================================================
      - name: Append series_url from /rank/
        run: |
          set -euo pipefail
          python tools/append_series_url_from_web.force_dom.py \
            --from-url "https://www.autohome.com.cn/rank/1-3-1071-x/" \
            --out data/autohome_raw_$(date +'%Y-%m')_with_url.csv

      # ================================================================
      # 2️⃣ Enrich brand/model from <title>
      # ================================================================
      - name: Enrich brand/model from <title>
        run: |
          set -euo pipefail
          python tools/enrich_brand_model_from_title.py \
            --input data/autohome_raw_$(date +'%Y-%m')_with_url.csv \
            --output data/autohome_raw_$(date +'%Y-%m')_with_brand.csv

      # ================================================================
      # 3️⃣ Translate brand/model to global names
      # ================================================================
      - name: Translate brand/model to global names (official → Wikipedia → LLM)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          targets=()
          for f in data/autohome_raw_*_with_brand.csv; do
            out="${f%.csv}_ja.csv"
            if [ ! -f "$out" ] || [ "$f" -nt "$out" ]; then
              targets+=("$f")
            fi
          done

          if [ ${#targets[@]} -eq 0 ]; then
            echo "No files need translation."
            exit 0
          fi

          for inp in "${targets[@]}"; do
            out="${inp%.csv}_ja.csv"
            echo "Translating: $inp -> $out"
            python tools/translate_brand_model_llm.py \
              --input "$inp" \
              --output "$out" \
              --brand-col brand --model-col model \
              --brand-ja-col brand_ja --model-ja-col model_ja \
              --model gpt-4o \
              --use-official --use-wikipedia
          done

      # ================================================================
      # 4️⃣ Commit artifacts
      # ================================================================
      - name: List outputs before commit
        run: ls -lh data/*.csv || true

      - name: Commit artifacts
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add data/*.csv || true
          git commit -m "Monthly update: $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push || echo "No changes to push"
