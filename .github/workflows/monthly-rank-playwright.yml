name: run

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 2 * * *'  # 毎日 11:00JST に相当(必要に応じて)

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt || true
          pip install pandas requests beautifulsoup4 playwright
          python -m playwright install --with-deps chromium

      # 1) series_url 付与（Playwright / キャッシュ無し）
      - name: Append series_url from web (Playwright; no cache)
        run: |
          set -euo pipefail
          IN1="data/autohome_raw_2025-08.csv"
          IN2="data/autohome_raw_2025-09.csv"
          IN3="data/autohome_raw_2025-10.csv"
          RANK="https://www.autohome.com.cn/rank/1-3-1071-x/"

          for IN in "$IN1" "$IN2" "$IN3"; do
            if [ -f "$IN" ]; then
              OUT="${IN%.csv}_with_series.csv"
              echo "🧾 input: $IN"
              python tools/append_series_url_from_web.playwright_full.py \
                --rank-url "$RANK" \
                --input "$IN" \
                --output "$OUT" \
                --name-col model --max-rounds 1 --idle-ms 200 --min-delta 0
            else
              echo "Input not found: $IN"
            fi
          done

      # 2) <title> から brand/model を抽出（旧仕様・--series-url-col 対応）
      - name: Enrich brand/model from <title> (no cache)
        run: |
          set -euo pipefail
          for IN in data/autohome_raw_*_with_series.csv; do
            [ -f "$IN" ] || continue
            OUT="${IN/_with_series.csv/_with_brand.csv}"
            echo "Translating(Official->Wiki->LLM): $IN -> $OUT"
            python tools/enrich_brand_model_from_title.py \
              --input "$IN" \
              --output "$OUT" \
              --series-url-col series_url \
              --brand-col brand --model-col model \
              --title-col title_raw \
              --sleep 0.6
          done

      # 3) Official→Wikipedia→LLM の順でグローバル名付与（キャッシュ無し）
      - name: Translate brand/model to global names (Wikipedia + optional official)
        env:
          GOOGLE_CSE_ID: ${{ secrets.GOOGLE_CSE_ID }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          for IN in data/autohome_raw_*_with_brand.csv; do
            [ -f "$IN" ] || continue
            OUT="${IN/_with_brand.csv/_with_brand_ja.csv}"
            echo "Translating: $IN -> $OUT"
            python tools/translate_brand_model_llm.py \
              --input "$IN" \
              --output "$OUT" \
              --brand-col brand --model-col model \
              --brand-ja-col brand_ja --model-ja-col model_ja \
              --model-official-en-col model_official_en \
              --source-col source_model \
              --use-official --use-wikipedia --use-llm \
              --llm-model gpt-4o-mini \
              --sleep 0.6 --no-cache
          done

      - name: List outputs before commit
        run: |
          ls -lh data | tail -n 200 || true

      - name: Commit artifacts
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "auto: append + enrich + translate (no cache, restored legacy flow)" || echo "nothing to commit"
          git push
