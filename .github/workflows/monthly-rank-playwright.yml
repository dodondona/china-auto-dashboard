name: Autohome link+title scrape (reverted minimal)

on:
  workflow_dispatch:
  schedule:
    - cron: "15 1 2 * *"  # 毎月2日 10:15(JST)相当。必要に応じて調整

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install playwright beautifulsoup4 lxml pandas
          python -m playwright install chromium

      - name: Compute month (previous month by default)
        id: month
        shell: bash
        run: |
          # 前月の年月 (例: 2025-09)
          MONTH=$(date -u -d "$(date +%Y-%m-01) -1 day" +%Y-%m)
          echo "month=$MONTH" >> $GITHUB_OUTPUT

      - name: Run scraper (link + title only)
        run: |
          python tools/autohome_link_title_scraper.py \
            --month "${{ steps.month.outputs.month }}" \
            --out "data/autohome_raw_${{ steps.month.outputs.month }}_with_brand.csv"

      - name: Ensure JA columns exist (noop translator)
        run: |
          python tools/noop_translate_stub.py \
            --csv "data/autohome_raw_${{ steps.month.outputs.month }}_with_brand.csv"

      - name: Commit & push results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "data: autohome link+title scraped for ${{ steps.month.outputs.month }} (reverted minimal)"
            git push
          fi
