name: Monthly append series_url & enrich brand/model (rank/1 + global translation)

on:
  workflow_dispatch:
  schedule:
    - cron: "15 1 2 * *"  # 毎月2日 10:15 JST（1:15 UTC）

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install --with-deps chromium

      - name: Append series_url from /rank/
        run: |
          set -euo pipefail
          python tools/append_series_url_from_web.force_dom.py \
            --rank-url "https://www.autohome.com.cn/rank/1-3-1071-x/" \
            --input data/autohome_raw_2025-08.csv \
            --output data/autohome_raw_2025-08_with_brand.csv \
            --name-col title_raw

      - name: Enrich brand/model from <title>
        run: |
          set -euo pipefail
          python tools/enrich_brand_model_from_title.py \
            --input data/autohome_raw_2025-08_with_brand.csv \
            --output data/autohome_raw_2025-08_with_brand_ja.csv

      - name: Translate brand/model to global names (official → Wikipedia → LLM fallback)
        run: |
          set -euo pipefail
          python tools/translate_brand_model_llm.py \
            --input data/autohome_raw_2025-08_with_brand_ja.csv \
            --output data/autohome_raw_2025-08_final.csv \
            --brand-col brand \
            --model-col model \
            --brand-ja-col brand_ja \
            --model-ja-col model_ja \
            --use-official --use-wikidata --use-llm

      - name: List outputs before commit
        run: ls -lh data/ | grep autohome_raw_2025

      - name: Commit artifacts
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add data/autohome_raw_2025-08_final.csv
          git commit -m "update autohome_raw_2025-08_final.csv [auto]" || echo "No changes"
          git push
