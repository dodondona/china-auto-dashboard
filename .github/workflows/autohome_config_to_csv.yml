name: autohome_config_to_csv

on:
  workflow_dispatch:
  schedule:
    - cron: "25 1 2 * *"  # 毎月2日 01:25 UTC（＝北京時間9:25）

jobs:
  autohome_config_to_csv:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (Playwright + OpenAI)
        run: |
          python -m pip install --upgrade pip
          pip install playwright openai
          python -m playwright install chromium

      - name: Prepare output directory
        run: mkdir -p public/config_csv

      - name: Run autohome_config_to_csv per link
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -eux
          # spec_links.jsonl は from-spec-links ステップで生成済み
          if [ ! -s spec_links.jsonl ]; then
            echo "Error: spec_links.jsonl not found or empty."
            exit 1
          fi
          
          cat spec_links.jsonl | jq -c '.[]' | while read -r line; do
            rank=$(echo "$line" | jq -r .rank)
            series_id=$(echo "$line" | jq -r .series_id)
            spec_url=$(echo "$line" | jq -r .spec_url)

            printf -v rank3 "%03d" "$rank"
            base="${rank3}_${series_id}"
            outfile="public/config_csv/${base}.csv"

            echo "::group::[${rank3}] ${series_id} -> ${spec_url}"
            python tools/autohome_config_to_csv.py --series "${series_id}"
            echo "::endgroup::"
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: autohome-config-csvs
          path: public/config_csv
          if-no-files-found: error
