name: koubei_summary

on:
  workflow_dispatch:
    inputs:
      series_id:
        description: "Autohome series ID"
        required: true
        type: string
      pages:
        description: "Number of pages to fetch"
        required: true
        default: "5"
        type: string

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install playwright beautifulsoup4 lxml
          pip install pandas  # 既存ツールでCSVを使うため（必要なら）
          python -m playwright install chromium

      # ① 口コミ（詳細）収集＋キャッシュ＋zip出力（artifact 確認用）
      - name: Fetch koubei details (cache + zip)
        run: |
          set -euo pipefail
          python tools/koubei_summary_playwright.py "${{ inputs.series_id }}" "${{ inputs.pages }}"

      - name: Upload koubei detail cache
        uses: actions/upload-artifact@v4
        with:
          name: autohome_reviews_${{ inputs.series_id }}
          path: autohome_reviews_${{ inputs.series_id }}.zip

      # ② 既存の集計/整形 → CSV/中間生成物（あなたの従来パイプ）
      #    ※ 既存の tools/koubei_summary.py をそのまま使う想定（第二引数=ページ数）
      - name: Build CSV summary (existing step)
        run: |
          set -euo pipefail
          python tools/koubei_summary.py "${{ inputs.series_id }}" "${{ inputs.pages }}" || true

      # ③ API不要の長文レポ（既存）
      - name: Build narrative report
        run: |
          set -euo pipefail
          python tools/koubei_summary_to_report.py "${{ inputs.series_id }}" || true

      # ④ Story 生成（既存）: OPENAI_API_KEY があれば高品質化、無くてもテンプレで出力可能な実装にしてあるはず
      - name: Build story-style summary
        run: |
          set -euo pipefail
          python tools/koubei_storywriter.py "${{ inputs.series_id }}" --pros 5 --cons 4 --quotes 2 --style executive || true

      # ⑤ 仕上げの成果物（Story含む）をアップロード
      - name: Upload story & reports
        uses: actions/upload-artifact@v4
        with:
          name: koubei_story_and_reports_${{ inputs.series_id }}
          path: |
            output/koubei/${{ inputs.series_id }}/autohome_reviews_*_story.txt
            output/koubei/${{ inputs.series_id }}/*.txt
            output/koubei/${{ inputs.series_id }}/*.md
            output/koubei/${{ inputs.series_id }}/*.csv
