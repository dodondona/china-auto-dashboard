name: koubei_summary

on:
  workflow_dispatch:
    inputs:
      series_id:
        description: "Autohome series ID（例: 5769）"
        required: true
        type: string
      skip_llm:
        description: "LLM最終ポリッシュをスキップ（1でOFF/0でON）"
        required: false
        default: "0"
        type: string
      summary_fmt_ver:
        description: "出力フォーマットのバージョン（キャッシュ無効化トグル）"
        required: false
        default: "v1"
        type: string
      stop_after_consec_known:
        description: "既知IDに連続で当たったら打ち切る件数"
        required: false
        default: "50"
        type: string
      max_pages:
        description: "最大巡回ページ数（安全ガード）"
        required: false
        default: "20"
        type: string
  schedule:
    # 必要ならスケジュール更新。例: JST 01:30
    - cron: "30 16 * * *"  # UTC基準（JST+9=01:30）
  workflow_run:
    # 上流のパイプライン完了で発火させたい場合はワークフロー名を合わせる
    workflows: ["autohome_pipeline"]
    types: [completed]

permissions:
  contents: write  # （コミットしないが、将来pushしたくなった時のためにONで問題なし）

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      # 既定値（workflow_dispatchのinputsが優先）
      SUMMARY_FMT_VER: ${{ inputs.summary_fmt_ver || 'v1' }}
      SKIP_LLM: ${{ inputs.skip_llm || '0' }}
      STOP_AFTER_CONSEC_KNOWN: ${{ inputs.stop_after_consec_known || '50' }}
      MAX_PAGES: ${{ inputs.max_pages || '20' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install openai playwright beautifulsoup4 lxml
          python -m playwright install chromium

      - name: Prepare paths
        run: |
          set -euo pipefail
          sid="${{ inputs.series_id }}"
          test -n "$sid"
          mkdir -p "output/koubei/${sid}" "cache/koubei/${sid}"

      - name: Summarize Koubei with cache (incremental)
        env:
          SERIES_ID: ${{ inputs.series_id }}
        run: |
          set -euo pipefail
          python tools/koubei_cache_summary.py "${SERIES_ID}"

      - name: List outputs
        run: |
          set -euo pipefail
          sid="${{ inputs.series_id }}"
          echo "== cache =="
          ls -lah "cache/koubei/${sid}" || true
          echo "== output =="
          ls -lah "output/koubei/${sid}" || true

      - name: Upload artifacts (cache + outputs)
        uses: actions/upload-artifact@v4
        with:
          name: koubei-${{ inputs.series_id }}-${{ env.SUMMARY_FMT_VER }}
          retention-days: 14
          path: |
            cache/koubei/${{ inputs.series_id }}/summaries.jsonl
            cache/koubei/${{ inputs.series_id }}/raw_reviews.jsonl
            output/koubei/${{ inputs.series_id }}/*.md
