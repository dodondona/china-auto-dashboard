name: koubei_storywriter

on:
  workflow_dispatch:
    inputs:
      series_id:
        description: "Autohome series ID（例: 7806）"
        required: true
        type: string

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: "python -m pip install --upgrade pip && pip install pandas openai && pip install playwright beautifulsoup4 lxml requests || true && python -m playwright install chromium || true"

      # ① レビュー詳細を再取得して ZIP を作成（本文抽出は既存pyのまま）
      - name: Fetch koubei details and build zip
        run: "python tools/koubei_summary_playwright.py '${{ inputs.series_id }}' '5'"

      # ② ZIP → CSV 変換（既存 storywriter が読むCSVを生成）
      - name: Build CSV from JSON zip
        run: "python tools/koubei_summary_to_csv.py 'autohome_reviews_${{ inputs.series_id }}.zip'"

      # ③ 既存の要約スクリプトを“そのまま”実行（変更なし）
      - name: Generate story (use koubei_storywriter.py as-is)
        run: "python tools/koubei_storywriter.py '${{ inputs.series_id }}'"

      # 生成物を個別にアップロード（ヒア構文なし・パス1件ずつ）
      - name: Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: koubei_story_${{ inputs.series_id }}_csv
          path: autohome_reviews_${{ inputs.series_id }}.csv

      - name: Upload story TXT
        uses: actions/upload-artifact@v4
        with:
          name: koubei_story_${{ inputs.series_id }}_txt
          path: autohome_reviews_${{ inputs.series_id }}_story.txt

      - name: Upload story MD
        uses: actions/upload-artifact@v4
        with:
          name: koubei_story_${{ inputs.series_id }}_md
          path: autohome_reviews_${{ inputs.series_id }}_story.md

      - name: Build CSV/TXT from JSON
        run: |
          python tools/koubei_summary_to_csv.py "autohome_reviews_${{ inputs.series_id }}.zip"

      - name: Install deps for storywriter
        run: |
          python -m pip install --upgrade pip
          pip install openai pandas

      - name: Run storywriter (summary)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python tools/koubei_storywriter.py "${{ inputs.series_id }}"

      - name: Upload artifacts (CSV & Story)
        uses: actions/upload-artifact@v4
        with:
          name: autohome-summary-${{ inputs.series_id }}
          path: |
            autohome_reviews_${{ inputs.series_id }}.csv
            autohome_reviews_${{ inputs.series_id }}_story.txt
            autohome_reviews_${{ inputs.series_id }}_story.md

