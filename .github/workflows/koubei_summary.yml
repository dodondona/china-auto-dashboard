name: koubei_summary

on:
  workflow_dispatch:
    inputs:
      series_id:
        description: "Autohome series ID（例: 5769）"
        required: true
        type: string
      pages:
        description: "巡回ページ数（必要に応じて）"
        required: false
        default: "5"
        type: string
  schedule:
    - cron: "30 16 * * *"  # JST 01:30
  workflow_run:
    workflows: ["autohome_pipeline"]
    types: [completed]

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      SERIES_ID: ${{ inputs.series_id }}
      PAGES: ${{ inputs.pages }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install playwright beautifulsoup4 lxml openai
          python -m playwright install chromium

      - name: Prepare directories
        run: |
          set -euo pipefail
          mkdir -p "cache/koubei/${SERIES_ID}" || true
          mkdir -p "output/koubei/${SERIES_ID}" || true

      - name: Run koubei summary (with cache support)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          python tools/koubei_summary_playwright.py "${SERIES_ID}" "${PAGES}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: koubei-${{ inputs.series_id }}
          retention-days: 14
          path: |
            cache/koubei/${{ inputs.series_id }}/
            output/koubei/${{ inputs.series_id }}/
            autohome_reviews_*.csv
            autohome_reviews_*.json
            autohome_reviews_*.md
            autohome_reviews_*.txt
