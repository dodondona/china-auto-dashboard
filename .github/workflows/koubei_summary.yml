name: koubei_summary

on:
  workflow_dispatch:
    inputs:
      series_id:
        description: "Autohome series ID"
        required: true
        type: string
      pages:
        description: "Number of review pages to fetch"
        required: true
        type: string

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install playwright beautifulsoup4 lxml requests pandas openai
          python -m playwright install chromium || true

      # ① Playwrightでレビュー本文取得
      - name: Fetch Koubei detail pages
        run: |
          python tools/koubei_summary_playwright.py "${{ inputs.series_id }}" "${{ inputs.pages }}"

      # ② JSON→CSV化（ルート直下）
      - name: Build CSV/TXT from JSON
        run: |
          python tools/koubei_summary_to_csv.py "autohome_reviews_${{ inputs.series_id }}.zip"

      # ③ storywriter実行前確認（CSV内容ログ）
      - name: Preflight check
        run: |
          python - <<'PY'
          import pandas as pd
          from tools.koubei_storywriter import detect_csv
          sid = "${{ inputs.series_id }}".strip()
          csv_path = detect_csv(sid)
          df = pd.read_csv(csv_path)
          print(f"[preflight] csv_path={csv_path}")
          print(f"[preflight] rows={len(df)} cols={list(df.columns)}")
          print(df.head(3).to_string(index=False))
          PY

      # ④ storywriterで要約生成
      - name: Run storywriter
        run: |
          python tools/koubei_storywriter.py "${{ inputs.series_id }}"

      # ⑤ 出力確認
      - name: Postflight verification
        run: |
          ID="${{ inputs.series_id }}"
          ls -lh autohome_reviews_${ID}.csv autohome_reviews_${ID}_story.txt autohome_reviews_${ID}_story.md
          wc -l autohome_reviews_${ID}.csv || true
          wc -c autohome_reviews_${ID}_story.txt autohome_reviews_${ID}_story.md || true

      # ⑥ 成果物をArtifact化
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: autohome-summary-${{ inputs.series_id }}
          path: |
            autohome_reviews_${{ inputs.series_id }}.csv
            autohome_reviews_${{ inputs.series_id }}_story.txt
            autohome_reviews_${{ inputs.series_id }}_story.md
