name: autohome_pipeline_to_koubei

on:
  workflow_run:
    workflows: ["autohome_pipeline"]   # â† ä¸ŠæµWorkflowã® name ã¨ä¸€è‡´ã•ã›ã‚‹
    types: [completed]

jobs:
  prepare-ids:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    outputs:
      ids_json: ${{ steps.build_matrix.outputs.ids_json }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts from upstream
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Ensure jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Build series id list (no heredoc)
        id: build_matrix
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          : > series_ids.txt

          # artifacts å†…ã‹ã‚‰æŠ½å‡º
          if compgen -G "artifacts/**" > /dev/null; then
            grep -RhoE '"series_id"\s*:\s*[0-9]+' artifacts/** 2>/dev/null | grep -oE '[0-9]+' >> series_ids.txt || true
            grep -RhoE '/series/[0-9]+\.html'             artifacts/** 2>/dev/null | grep -oE '[0-9]+' >> series_ids.txt || true
            grep -RhoE 'https?://k\.autohome\.com\.cn/[0-9]+' artifacts/** 2>/dev/null | grep -oE '[0-9]+' >> series_ids.txt || true
          fi

          # public å†…ã‹ã‚‰ã‚‚æŠ½å‡ºï¼ˆå¿…è¦ãªå ´åˆï¼‰
          if compgen -G "public/**" > /dev/null; then
            grep -RhoE '"series_id"\s*:\s*[0-9]+' public/** 2>/dev/null | grep -oE '[0-9]+' >> series_ids.txt || true
            grep -RhoE '/series/[0-9]+\.html'             public/** 2>/dev/null | grep -oE '[0-9]+' >> series_ids.txt || true
            grep -RhoE 'https?://k\.autohome\.com\.cn/[0-9]+' public/** 2>/dev/null | grep -oE '[0-9]+' >> series_ids.txt || true
          fi

          if [ ! -s series_ids.txt ]; then
            echo "::error::No series IDs were found in artifacts/public."
            exit 1
          fi

          sort -u series_ids.txt > series_ids.uniq.txt
          echo "Found $(wc -l < series_ids.uniq.txt) unique series IDs"
          head -n 20 series_ids.uniq.txt || true

          # JSONé…åˆ—ã«æ•´å½¢ï¼ˆ["4745","7806",...])
          ids_json="$(jq -R -s -c 'split("\n")|map(select(length>0))' series_ids.uniq.txt)"
          echo "ids_json=${ids_json}" >> "$GITHUB_OUTPUT"

  # ğŸ”½ å†åˆ©ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ â€œjob ãƒ¬ãƒ™ãƒ«ã§ uses:â€
  run-koubei:
    needs: prepare-ids
    if: ${{ needs.prepare-ids.outputs.ids_json != '' }}
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        series_id: ${{ fromJson(needs.prepare-ids.outputs.ids_json) }}
    uses: ./.github/workflows/koubei_summary.yml
    with:
      # â˜…ã‚ãªãŸã® koubei_summary.yml ã® input åã«åˆã‚ã›ã‚‹ï¼ˆvehicle_id ã§ç¶­æŒï¼‰
      vehicle_id: ${{ matrix.series_id }}
      pages: "5"
    secrets: inherit
