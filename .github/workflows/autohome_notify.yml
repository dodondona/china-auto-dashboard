name: autohome_notify

on:
  schedule:
    - cron: "20 9 11 * *"  # æ¯æœˆ11æ—¥ 09:20 UTCï¼ˆä¸­å›½æ™‚é–“17:20é ƒï¼‰
  workflow_dispatch:

jobs:
  detect_and_notify:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
      TARGET_URL: "https://www.autohome.com.cn/rank/1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip playwright
          python -m playwright install chromium
          python -m playwright install-deps

      # ====== ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆæ—¢å­˜Stage1/Stage2åˆ©ç”¨ï¼‰ ======
      - name: Run scraper
        run: |
          mkdir -p data
          python tools/rank1_stage1_ranklist.py --url "${TARGET_URL}" --out "data/autohome_raw_latest.csv"
          python tools/rank1_stage2_enrich.py --inp "data/autohome_raw_latest.csv" --out "data/autohome_raw_latest_enriched.csv"

      # ====== ãƒãƒƒã‚·ãƒ¥æ¯”è¼ƒ ======
      - name: Compare hash
        id: check
        run: |
          md5sum data/autohome_raw_latest_enriched.csv > new_hash.txt
          if [ -f data/last_hash.txt ]; then
            diff data/last_hash.txt new_hash.txt && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Save hash
        if: always()
        run: cp new_hash.txt data/last_hash.txt

      # ====== é€šçŸ¥ï¼ˆGitHub Actionsæ¨™æº–ãƒ¡ãƒ¼ãƒ«ï¼‰ ======
      - name: Notify if changed
        if: ${{ steps.check.outputs.changed == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const msg = `
ğŸ“Š **Autohomeãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ**

URL: ${process.env.TARGET_URL}
æ—¥æ™‚: ${new Date().toLocaleString("zh-CN", { timeZone: "Asia/Shanghai" })}
ãƒ•ã‚¡ã‚¤ãƒ«: data/autohome_raw_latest_enriched.csv

â†’ GitHubä¸Šã§ã“ã®Actions runã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
`;
            core.notice(msg);
            core.summary.addHeading("Autohomeãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°é€šçŸ¥");
            core.summary.addCodeBlock(msg);
            await core.summary.write();
