name: Mirror to Public Repo (GitHub Pages)

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - autohome_pipeline
      - autohome_pipeline_hezi
      - autohome_pipeline_to_koubei
      - autohome_config_to_csv
      - koubei_summary
    types: [completed]

permissions:
  contents: read

env:
  PUBLIC_REPO: ${{ secrets.PUBLIC_REPO_NAME }}
  PUBLIC_OWNER: ${{ github.repository_owner }}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone public repo
        run: |
          git clone --depth=1 https://github.com/${PUBLIC_OWNER}/${PUBLIC_REPO}.git pub

      - name: Copy artifacts (output + public/* except index.html)
        run: |
          # index.html„Çí‰∏ÄÊôÇÈÄÄÈÅø
          if [ -f "pub/index.html" ]; then
            cp pub/index.html /tmp/index.html.backup
            echo "‚úÖ Backed up existing index.html"
          fi
          
          rm -rf pub/*
          mkdir -p pub/output
          # ‚úÖ outputÈÖç‰∏ã„ÅÆÂÖ®ÊàêÊûúÁâ©„Çí„Ç≥„Éî„Éº
          cp -r output/* pub/output/ || true
          # ‚úÖ publicÈÖç‰∏ã„ÅÆHTML„ÇÑÈùôÁöÑ„Éï„Ç°„Ç§„É´„Çí„Ç≥„Éî„ÉºÔºàindex.htmlÈô§Â§ñÔºâ
          if [ -d "public" ]; then
            # index.html‰ª•Â§ñ„Çí„Ç≥„Éî„Éº
            find public -maxdepth 1 -type f ! -name 'index.html' -exec cp {} pub/ \; || true
            # „Çµ„Éñ„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅØÂÖ®„Å¶„Ç≥„Éî„Éº
            find public -maxdepth 1 -mindepth 1 -type d -exec cp -r {} pub/ \; || true
            echo "‚úÖ Copied public/* to pub/ (excluding index.html)"
          else
            echo "‚ö†Ô∏è No public/ folder found"
          fi
          
          # index.html„ÇíÂæ©ÂÖÉ
          if [ -f "/tmp/index.html.backup" ]; then
            cp /tmp/index.html.backup pub/index.html
            echo "‚úÖ Restored existing index.html"
          fi

      - name: Commit & push to public repo
        working-directory: pub
        env:
          TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Sync from private repo at $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push https://x-access-token:${TOKEN}@github.com/${PUBLIC_OWNER}/${PUBLIC_REPO}.git main

      - name: Force refresh commit (for cache purge)
        working-directory: pub
        env:
          TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          echo "$(date)" > .force_refresh.txt
          git add .force_refresh.txt
          git commit -m "Force refresh $(date)" || echo "no diff"
          git push https://x-access-token:${TOKEN}@github.com/${PUBLIC_OWNER}/${PUBLIC_REPO}.git main

      - name: Confirm contents
        run: |
          echo "===== pub/ structure after sync ====="
          find pub -maxdepth 2 -type f | sort

      - name: Purge Cloudflare cache (GitHub Pages)
        if: always()
        env:
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          if [ -z "$CF_ZONE_ID" ] || [ -z "$CF_API_TOKEN" ]; then
            echo "‚ö†Ô∏è CF credentials not set; skipping purge"
          else
            echo "üßπ Purging Cloudflare cache for GitHub Pages..."
            curl -X POST "https://api.cloudflare.com/client/v4/zones/$CF_ZONE_ID/purge_cache" \
              -H "Authorization: Bearer $CF_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'
            echo "‚úÖ Cache purge complete"
          fi
