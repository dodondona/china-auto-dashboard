name: Deploy to Cloudflare Pages

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["autohome_pipeline"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh jq unzip

      - name: Restore latest output artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "ðŸ” Searching for latest successful workflow run with output artifacts..."
          WF_ID=$(gh api repos/${{ github.repository }}/actions/workflows | jq -r '.workflows[] | select(.name=="autohome_pipeline") | .id' | head -n1)
          if [ -z "$WF_ID" ]; then
            echo "âŒ autohome_pipeline not found"
            exit 1
          fi

          RUN_JSON=$(gh api repos/${{ github.repository }}/actions/workflows/$WF_ID/runs?branch=main&status=success&per_page=10)
          RUN_ID=$(echo "$RUN_JSON" | jq -r '.workflow_runs[].id' | head -n1)
          if [ -z "$RUN_ID" ]; then
            echo "âŒ No successful runs found"
            exit 1
          fi
          echo "âœ… Using run_id=$RUN_ID"

          mkdir -p output
          ART_JSON=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts)
          echo "$ART_JSON" | jq -r '.artifacts[] | "\(.id) \(.name)"' | while read -r ID NAME; do
            echo "â¬‡ï¸ Downloading artifact: $NAME (id=$ID)"
            gh api repos/${{ github.repository }}/actions/artifacts/$ID/zip > "$NAME.zip"
            unzip -o "$NAME.zip" -d output/
          done
          echo "âœ… Restored output/ successfully."

      - name: Prepare public directory
        run: |
          set -euo pipefail
          mkdir -p public
          cp -r output public/output/
          echo "/output/*" > public/_headers
          echo "  Content-Type: text/plain; charset=utf-8" >> public/_headers
          echo "  Cache-Control: no-store, no-cache, must-revalidate, max-age=0" >> public/_headers
          echo "  Access-Control-Allow-Origin: *" >> public/_headers
          echo "  Access-Control-Allow-Methods: GET, OPTIONS" >> public/_headers
          echo "/*" >> public/_headers
          echo "  Cache-Control: no-store, no-cache, must-revalidate, max-age=0" >> public/_headers

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: "china-auto-dashboard"
          directory: "public"
