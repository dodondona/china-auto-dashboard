name: Deploy to Cloudflare Pages

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["autohome_pipeline"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh jq unzip

      - name: Restore output from latest successful artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p output
          WORKFLOWS=("autohome_pipeline" "autohome_config_to_csv" "autohome_pipeline_to_koubei")
          for WF in "${WORKFLOWS[@]}"; do
            WF_ID=$(gh api repos/${{ github.repository }}/actions/workflows | jq -r ".workflows[] | select(.name==\"$WF\") | .id" | head -n1)
            if [ -z "$WF_ID" ]; then
              continue
            fi
            RUN_JSON=$(gh api repos/${{ github.repository }}/actions/workflows/$WF_ID/runs?branch=main&status=success&per_page=1)
            RUN_ID=$(echo "$RUN_JSON" | jq -r '.workflow_runs[0].id')
            if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
              continue
            fi
            ART_JSON=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts)
            COUNT=$(echo "$ART_JSON" | jq '.artifacts | length')
            if [ "$COUNT" -eq 0 ]; then
              continue
            fi
            echo "$ART_JSON" | jq -r '.artifacts[] | "\(.id) \(.name)"' | while read -r ID NAME; do
              gh api repos/${{ github.repository }}/actions/artifacts/$ID/zip > "$WF-$NAME.zip"
              unzip -o "$WF-$NAME.zip" -d output/
            done
          done

      - name: Prepare public directory
        run: |
          set -euo pipefail
          mkdir -p public
          cp -r output public/output/
          echo "/output/*" > public/_headers
          echo "  Content-Type: text/plain; charset=utf-8" >> public/_headers
          echo "  Cache-Control: no-store, no-cache, must-revalidate, max-age=0" >> public/_headers
          echo "  Access-Control-Allow-Origin: *" >> public/_headers
          echo "  Access-Control-Allow-Methods: GET, OPTIONS" >> public/_headers
          echo "/*" >> public/_headers
          echo "  Cache-Control: no-store, no-cache, must-revalidate, max-age=0" >> public/_headers

      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: "china-auto-dashboard"
          directory: "public"
