name: Deploy to Cloudflare Pages

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["autohome_pipeline"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y gh jq unzip

      - name: Restore latest output
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          WF_ID=$(gh api repos/${{ github.repository }}/actions/workflows | jq -r '.workflows[] | select(.name=="autohome_pipeline") | .id' | head -n1)
          RUN_JSON=$(gh api repos/${{ github.repository }}/actions/workflows/$WF_ID/runs?branch=main&status=success&per_page=1)
          RUN_ID=$(echo "$RUN_JSON" | jq -r '.workflow_runs[0].id')
          mkdir -p output
          ART_JSON=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts)
          echo "$ART_JSON" | jq -r '.artifacts[] | "\(.id) \(.name)"' | while read -r ID NAME; do
            gh api repos/${{ github.repository }}/actions/artifacts/$ID/zip > "$NAME.zip"
            unzip -o "$NAME.zip" -d output/
          done

      - name: Prepare public directory (force new hash)
        run: |
          set -euo pipefail
          mkdir -p public
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "ðŸ” Using hash: $COMMIT_HASH"

          # outputä»¥ä¸‹ã‚’ãã®ã¾ã¾ã‚³ãƒ”ãƒ¼ã—ã¤ã¤ã€å¼·åˆ¶çš„ã«æ›´æ–°æ‰±ã„ã«ã™ã‚‹
          cp -r output public/output/
          find public/output -type f -exec touch {} \;

          # ç©ºãƒ•ã‚¡ã‚¤ãƒ«ã«commitãƒãƒƒã‚·ãƒ¥ã‚’å…¥ã‚Œã¦ã€Cloudflareã®ãƒ‡ãƒ—ãƒ­ã‚¤è­˜åˆ¥ã‚’æ›´æ–°
          echo "$COMMIT_HASH" > public/_force_refresh_$COMMIT_HASH.txt

          # cacheç„¡åŠ¹ãƒ˜ãƒƒãƒ€ãƒ¼
          echo "/output/*" > public/_headers
          echo "  Cache-Control: no-store, no-cache, must-revalidate, max-age=0" >> public/_headers
          echo "  Access-Control-Allow-Origin: *" >> public/_headers
          echo "  Access-Control-Allow-Methods: GET, OPTIONS" >> public/_headers
          echo "/*" >> public/_headers
          echo "  Cache-Control: no-store, no-cache, must-revalidate, max-age=0" >> public/_headers

      - name: Publish to Cloudflare Pages (force upload)
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: "china-auto-dashboard"
          directory: "public"
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
