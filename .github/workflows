name: scrape

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "Autohome rank URL (例: https://www.autohome.com.cn/rank/1)"
        required: true
        default: "https://www.autohome.com.cn/rank/1"
  schedule:
    # 毎月11日 09:10 (UTC) に実行（中国サイトの集計更新に合わせて少し遅らせる）
    - cron: "10 9 11 * *"

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ← push する場合に必要（Settings > Actions > Workflow permissions も「Read and write」に）
    env:
      PYTHONUTF8: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PLAYWRIGHT_BROWSERS_PATH: 0
      TZ: Asia/Shanghai
      TARGET_URL: ${{ github.event.inputs.target_url || 'https://www.autohome.com.cn/rank/1' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install playwright
          python -m playwright install chromium
          # Ubuntu ランタイムに必要な依存を入れる
          python -m playwright install-deps

      # -------- Stage 1: ランキング → ベースCSV（リンク等を確実に取得） --------
      - name: Run Stage1 (rank list → base CSV)
        run: |
          mkdir -p data
          python tools/rank1_stage1_ranklist.py \
            --url "${TARGET_URL}" \
            --out "data/rank1_base.csv" \
            --wait-ms 220 \
            --max-scrolls 220

      # 中間物を保存（デバッグやダウンロード用）
      - name: Upload base CSV (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: rank1_base
          path: data/rank1_base.csv
          if-no-files-found: error

      # -------- Stage 2: 各シリーズページ巡回 → title / 種別 追記 --------
      - name: Run Stage2 (enrich CSV)
        run: |
          python tools/rank1_stage2_enrich.py \
            --inp "data/rank1_base.csv" \
            --out "data/rank1_enriched.csv"

      - name: Upload enriched CSV (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: rank1_enriched
          path: data/rank1_enriched.csv
          if-no-files-found: error

      # -------- 変更がある場合のみコミット＆プッシュ --------
      - name: Commit & push results
        if: ${{ github.ref == 'refs/heads/main' }}  # main ブランチでのみ
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # 変更があるか確認
          if git diff --quiet -- data/rank1_base.csv data/rank1_enriched.csv; then
            echo "No changes to commit."
            exit 0
          fi
          git add data/rank1_base.csv data/rank1_enriched.csv
          msg="data: rank/1 scraped & enriched ($(date -u +'%Y-%m-%dT%H:%MZ'))"
          git commit -m "${msg}"
          git push
